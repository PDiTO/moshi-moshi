import { schemaConfig } from "@/config/schemaConfig";
import { useEthersSigner } from "@/hooks/useEthersSinger";
import { EnsNamesResult, MyAttestationResult } from "@/types/easTypes";
import { SchemaRegistry } from "@ethereum-attestation-service/eas-sdk";
import axios from "axios";

export async function getPublicMessageAttestationsForAddress(
  address: string,
  apiPrefix: string
) {
  const baseURL = `https://${apiPrefix}easscan.org`;

  const response = await axios.post<MyAttestationResult>(
    `${baseURL}/graphql`,
    {
      query:
        "query Attestations($where: AttestationWhereInput, $orderBy: [AttestationOrderByWithRelationInput!]) {\n  attestations(where: $where, orderBy: $orderBy) {\n    attester\n    revocationTime\n    expirationTime\n    time\n    recipient\n    id\n    data\n  }\n}",

      variables: {
        where: {
          schemaId: {
            equals: schemaConfig.publicMessage,
          },
          OR: [
            {
              attester: {
                equals: address,
              },
            },
            {
              recipient: {
                equals: address,
              },
            },
          ],
        },
        orderBy: [
          {
            time: "desc",
          },
        ],
      },
    },
    {
      headers: {
        "content-type": "application/json",
      },
    }
  );
  return response.data.data.attestations;
}

export async function getThreadAttestationsForAddress(
  address: string,
  apiPrefix: string
) {
  const baseURL = `https://${apiPrefix}easscan.org`;

  const response = await axios.post<MyAttestationResult>(
    `${baseURL}/graphql`,
    {
      query:
        "query Attestations($where: AttestationWhereInput, $orderBy: [AttestationOrderByWithRelationInput!]) {\n  attestations(where: $where, orderBy: $orderBy) {\n    attester\n    revocationTime\n    expirationTime\n    time\n    recipient\n    id\n    data\n  }\n}",

      variables: {
        where: {
          schemaId: {
            equals: schemaConfig.thread,
          },
          revocationTime: {
            equals: 0,
          },
          OR: [
            {
              attester: {
                equals: address,
              },
            },
          ],
        },
        orderBy: [
          {
            time: "desc",
          },
        ],
      },
    },
    {
      headers: {
        "content-type": "application/json",
      },
    }
  );
  return response.data.data.attestations;
}

export async function getRecentThreads(apiPrefix: string) {
  const baseURL = `https://${apiPrefix}easscan.org`;

  const response = await axios.post<MyAttestationResult>(
    // `${baseURL}/graphql`,
    "http://localhost:4000/graphql",
    {
      query:
        "query Attestations($where: AttestationWhereInput, $orderBy: [AttestationOrderByWithRelationInput!]) {\n  attestations(where: $where, orderBy: $orderBy) {\n    attester\n    revocationTime\n    expirationTime\n    time\n    recipient\n    id\n    data\n  }\n}",

      variables: {
        where: {
          schemaId: {
            equals: schemaConfig.thread,
          },
          revocationTime: {
            equals: 0,
          },
        },
        orderBy: [
          {
            time: "desc",
          },
        ],
      },
    },
    {
      headers: {
        "content-type": "application/json",
      },
    }
  );
  return response.data.data.attestations;
}

export async function getPopularThreads(apiPrefix: string) {
  const baseURL = `https://${apiPrefix}easscan.org`;

  const response = await axios.post<MyAttestationResult>(
    `${baseURL}/graphql`,
    {
      query:
        "query Attestations($where: AttestationWhereInput, $orderBy: [AttestationOrderByWithRelationInput!]) {\n  attestations(where: $where, orderBy: $orderBy) {\n    refUID}\n}",

      variables: {
        where: {
          schemaId: {
            equals: schemaConfig.upVote,
          },
          revocationTime: {
            equals: 0,
          },
          refUID: {
            notIn: [
              "0x0000000000000000000000000000000000000000000000000000000000000000",
            ],
          },
        },
        orderBy: [
          {
            time: "desc",
          },
        ],
      },
    },
    {
      headers: {
        "content-type": "application/json",
      },
    }
  );
  return response.data.data.attestations;
}

export async function getThreadCommentAttestationsForUids(
  refUids: string[],
  apiPrefix: string
) {
  const baseURL = `https://${apiPrefix}easscan.org`;

  const response = await axios.post<MyAttestationResult>(
    `${baseURL}/graphql`,
    {
      query:
        "query Attestations($where: AttestationWhereInput, $orderBy: [AttestationOrderByWithRelationInput!]) {\n  attestations(where: $where, orderBy: $orderBy) {\n    attester\n    revocationTime\n    expirationTime\n    time\n    recipient\n    id\n    data\n  refUID\n  }\n}",

      variables: {
        where: {
          schemaId: {
            equals: schemaConfig.threadComment,
          },
          revocationTime: {
            equals: 0,
          },
          refUID: {
            in: refUids,
          },
        },
        orderBy: [
          {
            time: "desc",
          },
        ],
      },
    },
    {
      headers: {
        "content-type": "application/json",
      },
    }
  );
  return response.data.data.attestations;
}

export async function getUpVoteAttestationsForUids(
  refUids: string[],
  apiPrefix: string
) {
  const baseURL = `https://${apiPrefix}easscan.org`;

  const response = await axios.post<MyAttestationResult>(
    `${baseURL}/graphql`,
    {
      query:
        "query Attestations($where: AttestationWhereInput, $orderBy: [AttestationOrderByWithRelationInput!]) {\n  attestations(where: $where, orderBy: $orderBy) {\n    attester\n    revocationTime\n    expirationTime\n    time\n    recipient\n    id\n    data\n  refUID\n  }\n}",

      variables: {
        where: {
          schemaId: {
            equals: schemaConfig.upVote,
          },
          revocationTime: {
            equals: 0,
          },
          refUID: {
            in: refUids,
          },
        },
        orderBy: [
          {
            time: "desc",
          },
        ],
      },
    },
    {
      headers: {
        "content-type": "application/json",
      },
    }
  );
  return response.data.data.attestations;
}

export async function getProfilesForAddresses(
  addresses: string[],
  apiPrefix: string
) {
  const baseURL = `https://${apiPrefix}easscan.org`;

  const response = await axios.post<MyAttestationResult>(
    `${baseURL}/graphql`,
    {
      query:
        "query Attestations($where: AttestationWhereInput, $orderBy: [AttestationOrderByWithRelationInput!]) {\n  attestations(where: $where, orderBy: $orderBy) {\n    attester\n    revocationTime\n    expirationTime\n    time\n    recipient\n    id\n    data\n  refUID\n  }\n}",

      variables: {
        where: {
          schemaId: {
            equals: schemaConfig.profile,
          },
          revocationTime: {
            equals: 0,
          },
          attester: {
            in: addresses,
          },
        },
        orderBy: [
          {
            time: "desc",
          },
        ],
      },
    },
    {
      headers: {
        "content-type": "application/json",
      },
    }
  );
  return response.data.data.attestations;
}

export async function getENSNames(addresses: string[]) {
  const baseURL = `https://easscan.org`;

  const response = await axios.post<EnsNamesResult>(
    `${baseURL}/graphql`,
    {
      query:
        "query Query($where: EnsNameWhereInput) {\n  ensNames(where: $where) {\n    id\n    name\n  }\n}",
      variables: {
        where: {
          id: {
            in: addresses,
            mode: "insensitive",
          },
        },
      },
    },
    {
      headers: {
        "content-type": "application/json",
      },
    }
  );
  return response.data.data.ensNames;
}
